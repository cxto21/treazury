name: D4 - Deploy to Sepolia & Cloudflare Pages

on:
  push:
    branches:
      - main
    paths:
      - 'zkpassport_verifier/**'
      - 'src/web/**'
      - 'src/**'
      - '.Tests/**'
      - '.github/workflows/d4-deploy.yml'
  workflow_dispatch:  # Allow manual trigger

env:
  CAIRO_VERSION: "2.5.4"
  NOIR_VERSION: "1.0.0-beta.1"
  NODE_VERSION: "18.x"

jobs:
  test-cairo:
    name: Test Cairo Verifier
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Scarb
        run: |
          curl --proto '=https' --tlsv1.2 -sSf https://install.scarb.io | bash
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Verify Scarb installation
        run: scarb --version

      - name: Build Cairo contract
        working-directory: zkpassport_verifier
        run: |
          scarb clean
          scarb build

      - name: Run Cairo tests
        working-directory: zkpassport_verifier
        run: snforge test --verbose

  test-typescript:
    name: Test TypeScript & Frontend
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [18.x, 20.x]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Type check
        run: bun run type-check

      - name: Run E2E tests
        run: bun run test:e2e
        continue-on-error: true

      - name: Build frontend
        run: bun run build:web

  deploy-cairo:
    name: Deploy Cairo to Sepolia
    runs-on: ubuntu-latest
    needs: test-cairo
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Scarb & sncast
        run: |
          curl --proto '=https' --tlsv1.2 -sSf https://install.scarb.io | bash
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Create .sncast.toml
        run: |
          mkdir -p ~/.config/sncast
          cat > ~/.config/sncast/sncast.toml << 'EOF'
          [sepolia]
          account = "zkpassport_deployer"
          keystore = "~/.starknet_keys"
          network = "sepolia"
          rpc_url = "${{ secrets.STARKNET_RPC_URL }}"
          
          [zkpassport_deployer]
          private_key = "${{ secrets.STARKNET_PRIVATE_KEY }}"
          public_key = "${{ secrets.STARKNET_PUBLIC_KEY }}"
          address = "${{ secrets.STARKNET_ACCOUNT_ADDRESS }}"
          EOF

      - name: Build Cairo contract
        working-directory: zkpassport_verifier
        run: |
          scarb clean
          scarb build

      - name: Declare contract on Sepolia
        working-directory: zkpassport_verifier
        run: |
          DECLARATION=$(sncast --profile sepolia declare \
            --contract-name zkpassport_verifier \
            --compiled-contract target/release/zkpassport_verifier_zkpassport_verifier.compiled_contract_class.json)
          echo "DECLARATION=$DECLARATION" >> $GITHUB_ENV

      - name: Deploy contract instance
        working-directory: zkpassport_verifier
        run: |
          DEPLOYMENT=$(sncast --profile sepolia deploy \
            --class-hash $(echo $DECLARATION | grep -oP 'class hash: \K[^,]*') \
            --constructor-calldata 0x$(sncast signer address))
          echo "DEPLOYMENT=$DEPLOYMENT" >> $GITHUB_ENV

      - name: Update deployments/sepolia.json
        run: |
          CLASS_HASH=$(echo $DECLARATION | grep -oP 'class hash: \K[^,]*')
          CONTRACT_ADDRESS=$(echo $DEPLOYMENT | grep -oP 'contract address: \K[^,]*')
          
          jq --arg class "$CLASS_HASH" \
             --arg addr "$CONTRACT_ADDRESS" \
             '.contracts.ZKPassportVerifier.class_hash = $class |
              .contracts.ZKPassportVerifier.address = $addr |
              .contracts.ZKPassportVerifier.status = "Active on Sepolia"' \
             deployments/sepolia.json > deployments/sepolia.json.tmp
          
          mv deployments/sepolia.json.tmp deployments/sepolia.json

      - name: Commit deployment info
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add deployments/sepolia.json
          git commit -m "chore: update Sepolia deployment info [skip ci]" || true
          git push

  deploy-frontend:
    name: Deploy Frontend to Cloudflare Pages
    runs-on: ubuntu-latest
    needs: test-typescript
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Create .env.local for build
        run: |
          cat > .env.local << 'EOF'
          VITE_STARKNET_RPC=${{ secrets.VITE_STARKNET_RPC }}
          VITE_ZKPASSPORT_CONTRACT=${{ secrets.VITE_ZKPASSPORT_CONTRACT }}
          VITE_TONGO_CONTRACT=${{ secrets.VITE_TONGO_CONTRACT }}
          VITE_ENVIRONMENT=production
          VITE_NETWORK=sepolia
          EOF

      - name: Build frontend
        run: bun run build:deploy

      - name: Deploy to Cloudflare Pages
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          projectName: treazury-sepolia
          directory: dist
          productionBranch: main

  verify-deployment:
    name: Verify On-Chain Deployment
    runs-on: ubuntu-latest
    needs: deploy-cairo
    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Scarb & sncast
        run: |
          curl --proto '=https' --tlsv1.2 -sSf https://install.scarb.io | bash
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Load deployment info
        id: deployment
        run: |
          CONTRACT_ADDRESS=$(jq -r '.contracts.ZKPassportVerifier.address' deployments/sepolia.json)
          echo "contract_address=$CONTRACT_ADDRESS" >> $GITHUB_OUTPUT

      - name: Verify contract on Sepolia
        run: |
          CONTRACT=${{ steps.deployment.outputs.contract_address }}
          
          if [ "$CONTRACT" == "PENDING_DEPLOYMENT" ]; then
            echo "‚ö†Ô∏è  Contract not yet deployed. Running manual deployment instead."
            exit 0
          fi
          
          echo "Verifying contract: $CONTRACT"
          sncast --profile sepolia call \
            --contract-address $CONTRACT \
            --function-name total_verifications \
            || echo "‚ö†Ô∏è  Verification call failed (contract may not be deployed yet)"

      - name: Send deployment notification
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const sepolia = JSON.parse(fs.readFileSync('deployments/sepolia.json', 'utf8'));
            const verifier = sepolia.contracts.ZKPassportVerifier;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number || 0,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## üöÄ Deployment Status\n\n**Cairo Verifier (Sepolia)**\n- Status: ${verifier.status}\n- Address: ${verifier.address}\n- Class Hash: ${verifier.class_hash}\n\n**Frontend (Cloudflare Pages)**\n- Deploying to: \`treazury-sepolia.pages.dev\`\n- Status: In progress`
            });

  notify-slack:
    name: Send Slack Notification
    runs-on: ubuntu-latest
    needs: [test-cairo, test-typescript, deploy-cairo, deploy-frontend]
    if: always()
    steps:
      - name: Send Slack notification
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            {
              "text": "Treazury D4 Deployment",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "üöÄ Treazury D4 Deployment Update"
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Workflow*: ${{ github.workflow }}\n*Branch*: ${{ github.ref_name }}\n*Commit*: ${{ github.sha }}"
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "üìã **Test Results**\n‚Ä¢ Cairo Tests: ${{ needs.test-cairo.result }}\n‚Ä¢ TypeScript Tests: ${{ needs.test-typescript.result }}\n‚Ä¢ Cairo Deployment: ${{ needs.deploy-cairo.result }}\n‚Ä¢ Frontend Deployment: ${{ needs.deploy-frontend.result }}"
                  }
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Workflow"
                      },
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
        if: always()
